# Abstract

Species interactions are believed to play an important role in community structure, but detecting their influence in observed communities has stymied ecologists for decades.  In recent years, several papers have suggested that ecologists could solve this long-standing problem by fitting Markov networks (undirected graphical models also known as Markov random fields) to the data by maximum likelihood or similar methods.  This approach allows ecologists to control for extraneous factors when estimating the direct interactions between a given pair of species, and previous work has shown that this kind of control is required for reliable inferences.  Unfortunately, the likelihood function for Markov networks quickly becomes intractable once more than about 20 species are included in the model, due to the exponentially large number of possible combinations of presences and absences. Additionally, the methods that have been proposed so far do not account for environmental heterogeneity, and attempt to explain *all* of the co-occurrence patterns in ecological data sets with species interactions. In this paper, I introduce *stochastic approximation* as a method for fitting these models to large ecological networks where hundreds of species and multiple abiotic factors can all affect a given species’ occurrence probability.  This approach, which converges to the maximum likelihood estimate with probability one, greatly expands the range of data sets we can analyze and the number of ecological questions we can address with these methods.

# Introduction

To the extent that species interactions are important for community assembly, ecologists generally expect them to leave a signature on species' co-occurrence patterns.  But using that signature to infer the underlying species interactions has been much harder.  Disagreements about how to draw these inferences led to an acrimonious, decade-long argument among community ecologists [@lewin_santa_1983], where essentially all of the proposed statistical approaches were criticized for having high error rates, a poor match with the underlying ecological questions, computational infeasibility, or all three [@connor_assembly_1979; @strong_ecological_1984; @hastings_can_1987]. As documented below, ecologists have, for the most part, not solved these problems in the ensuing decades.

During the time that ecologists have struggled to identify the interactions among dozens of species, bioinformaticians have largely solved the analogous problem of estimating interactions among *thousands* of genes from their co-expression levels (e.g. @friedman_sparse_2008). The discrepancy is due to the fact that ecologists have focused, almost exclusively, on overall co-occurrence rates [@connor_assembly_1979; @gotelli_empirical_2009; @gilpin_factors_1982; @veech_probabilistic_2013] or on closely-related values such as correlation coefficients [@pollock_understanding_2014; see @faisal_inferring_2010 for a recent exception]. As ecologists know, however, the correlation between two species will often reflect other factors beyond their direct pairwise interactions (Figure 1). When these factors are not accounted for, this reliance on overall co-occurrence rates can reliably lead to incorrect inferences [@harris_estimating_2015]. While some methods have been proposed for incorporating a small number of specific factors (such as geographic or environmental dissimilarity) into ecologists' null models at a time [@lessard_strong_2011], we still don't have a good way to scale these approaches up for cases with many biotic and abiotic factors acting simultaneously.

![A hypothetical network of three species, two of which depend on an abiotic factor (annual rainfall).  **A.** The “true” network involves the caterpillar exploiting the two tree species as well as competition between the two trees.  The two trees also benefit from rainfall.  **B.** Although the two trees directly reduce one another’s occurrence probabilities via competition, they tend to occur in the same areas (with sufficient water and without too many herbivores).  An analysis that ignores these other factors could mistakenly conclude that the two trees were mutualists because of their high co-occurrence rate.  **C.** The methods presented here are designed to estimate the direct interactions between each pair of species, after accounting for other species and abiotic factors that could affect their co-occurrence rates. Note that, with observational data, the bi-directional effects of species interactions (pairs of arrows between species) need to be collapsed to a single number describing the conditional relationship between species (one double-headed arrow).](figure-1.pdf)

A number of procedures have been developed for controlling for the influence of extraneous factors and focusing on the direct relationship between a single pair of variables, i.e. for estimating the *conditional* relationship between them.  The most familiar of these is the partial correlation. Rather than describing the *overall* relationship between two variables across *all* conditions, partial correlations (like regression coefficients) describe the portion of the relationship that remains after the other variables in the data have been accounted for.  @harris_estimating_2015 found that the partial correlation can do a surprisingly good job of extracting accurate information about pairwise species interactions from binary co-occurrence data in some circumstances, but the fact that this approach assumes multivariate Gaussian data makes it less appealing.

Recently, several papers have suggested that ecologists could use Markov networks (undirected graphical models also known as Markov random fields) to estimate conditional relationships from binary data by maximum entropy or maximum likelihood (@azaele_inferring_2010; @fort_statistical_2013; @harris_estimating_2015). A Markov network defines a probability distribution over possible binary species assemblages, and its coefficients (including one coefficient describing the conditional relationship between each pair of species in the network).  Unfortunately, Markov networks have an intractable likelihood function whose computational complexity more than doubles each time a new species is added to the model. Thus, while @azaele_inferring_2010 and @harris_estimating_2015 were able to optimize an exact objective function to maximize the constrained likelihood for networks of up to 20 species, extending these approaches to networks of 50-100 species would be completely infeasible. If ecologists want the model to account for abiotic variation among sites on the landscape, then these expensive computations need to be repeated independently for every site, increasing the computational burden even further.

In this paper, I present a different way of optimizing the likelihood, called *stochastic approximation* [@robbins_stochastic_1951; @salakhutdinov_efficient_2012], which replaces the intractable computations with tractable Monte Carlo estimates of the same quantities. Despite the sampling error introduced by this substitution, stochastic approximation provides strong guarantees for eventual convergence to the maximum likelihood estimate. This change in approach makes it feasible to estimate the interactions among hundreds of species from observational data while also accounting for possible responses to abiotic factors, possibly giving ecologists some power to distinguish between species pairs that co-occur due to shared environmental tolerances from those that co-occur due to direct interactions like mutualism.

# Methods

## Markov networks

As discussed in @azaele_inferring_2010, @fort_statistical_2013, and @harris_estimating_2015, Markov networks such as the Ising model [@cipra_introduction_1987] can be used to describe community structure as follows.  Each species is represented by a binary random variable, describing whether it is present or absent.  A species’ conditional probability of presence under a given set of biotic and abiotic conditions depends on its coefficients. The coefficients linking species to one another describe their conditional associations: *all else equal*, a species will occur less often in the presence of its competitors and other species with which it is negatively associated, and more often in the presence of its mutualists.

[[add math for conditional distributions; same as in chapter 2]]

These conditional probabilities can be combined to calculate the probability of observing any given combination of presences and absences [[Appendix?]].  

[[Add math for joint distribution; same as in chapter 2]]

Unfortunately, the extremely large number of possible assemblages makes this joint probability intractable when the number of species is large.  However, it is generally straightforward to simulate examples of assemblages that are consistent with graphical models such as these, using Monte Carlo techniques like Gibbs sampling [@salakhutdinov_efficient_2012]. Gibbs sampling is especially convenient for these models because it only requires the conditional probabilities, which are straightforward to compute (Harris 2015; Appendix).

In each of the scenarios below, the “observed” landscapes were simulated using Gibbs sampling from a pre-specified set of “true” parameters, then stochastic approximation was used to recover these parameters from the simulated presence-absence data.

## Conditioning the network on the abiotic environment

The Markov networks fit in @harris_estimating_2015 treated the $\alpha_i$ terms from Equations [[1 and 2]] as constants, meaning that the models expected each species to have the same conditional occurrence probability in any location with a given set of facilitators and competitors.  In this paper, I extend the model so that the local abiotic conditions can also affect species occurrence probabilities directly. Specifically, the $\alpha_i$ terms in these analyses are linear combinations of the local environmental conditions, represented by $x_1$ through $x_5$. By estimating the coefficients associated with each of these $x$ variables for each species, we can account for their responses to the abiotic environment as well as to one another.  In other fields, a model like this one, where a Markov network’s parameters depend on external factors is called a conditional random field [refs]; these models have been used in a variety of contexts, from language models to image processing [refs].

## Coefficient estimation with stochastic approximation

A Markov network describes a probability distribution over possible assemblages, and this distribution can be summarized without loss of information by its *sufficient statistics*.  For the model presented here, the sufficient statistics include: the number of occurrences for each species, the number of co-occurrences between each species, and the cross-product between the species and environment matrices [[*Appendix, not yet written*]].  One way to look at maximum likelihood estimation is that it minimizes the discrepancy between the sufficient statistics observed in the data and the average sufficient statistics produced by samples from the model [[ref?]]. Because fully-observed Markov networks, such as the ones analyzed here, have unimodal likelihood functions [@murphy_machine_2012], it is possible to find the global optimum by climbing the likelihood surface. At this point, any discrepancies between the sufficient statistics of the model and of the data will have been eliminated.

In order to reduce the discrepancy between the observed and predicted sufficient statistics, the `rosalia` calculates this different exactly, averaging over *all* possible presence-absence combinations. This approach is intractable for larger networks, as the number of possibilities grows exponentially with the size of the network. Stochastic approximation [refs] is a procedure that allows us to approximate the expected values of the sufficient statistics by averaging over a more manageable number of simulated assemblages during each model-fitting iteration, while still retaining maximum likelihood convergence guarantees [refs].  The procedure iterates through the following three steps as many times as needed (5000 for these analyses):

1: simulate a set of assemblages from the current model parameters and calculate sufficient statistics for the sample.
2: subtract the simulated sufficient statistics from the observed ones to calculate the approximate likelihood gradient
3: Adjust the model parameters to climb the approximate gradient, using a schedule of step sizes that satisfies the criteria in Chapter 6 of @powell_approximate_2007.

The specific procedure used here had the following implementation details:

The simulations in Step 1 used Gibbs sampling to generate examples of landscapes based on the model’s current parameter estimates. While the simulated landscapes produced by Gibbs sampling are serially autocorrelated, statisticians have shown that this merely slows convergence to the maximum likelihood estimate rather than preventing it altogether [@younes_convergence_1999; @salakhutdinov_efficient_2012].

The approximate likelihood gradients in Step 2 match the ones from the Appendix of @harris_estimating_2015, except that they are averaged over a set of Monte Carlo samples rather than over all possible presence-absence combinations. These gradients were augmented with a momentum term equal to 0.9 [@hinton_practical_2012] and by regularizers based on a logistic prior with location 0 and scale 1.0 (for environmental responses) or 0.1 (for pairwise interactions); the pairwise interaction terms were regularized more heavily to improve identifiability and reduce overfitting for this large set of 31,125 coefficients.

The step size parameter in Step 3, $\alpha_t$, decreased after each iteration according to a generalized harmonic sequence, $\alpha_t = \alpha_0 500/(500 - t - 1)$, which satisfies the criteria in @powell_approximate_2007. $\alpha_0$ was 1.0 for species’ intercepts and environmental responses. Because of the enormous number of pairwise interaction coefficients, I set $\alpha_0$ to 0.1 for the $\beta$ parameters.

## Simulated landscapes with known interactions

In order to assess the models' ability to recover the "true" parameters that generated a presence-absence matrix of interest, I first needed to generate such matrices from known processes.

To demonstrate that my stochastic approximation implementation could converge to the global optimum, I first simulated 10 landscapes with 20 species and 500 sites, using the Gibbs sampling approach described in @harris_estimating_2015.  These landscapes had few enough species that the `rosalia` package for estimating Markov networks [@rosalia_2015] could find the penalized maximum likelihood estimates for the Markov network in a reasonable amount of time.  For each of these simulated landscapes, I then fit the same model using both the exact approach from @harris_estimating_2015 and the stochastic approximation method described above.

I then simulated a large landscape with 250 species and 2500 sites, representing a large data set roughly the size of the North American Breeding Bird Survey.  Each site on the landscape was represented by 5 environmental variables, which were drawn independently from Gaussian distributions with mean 0 and standard deviation 2.

Each species was assigned two two sets of coefficients.  The coefficients determining species’ responses to the environment were each drawn from standard normal distributions.  The coefficients describing species’ pairwise interactions were drawn from a mixture of two zero-mean Gaussian distributions. 90% of the interaction coefficients were drawn from a distribution with standard deviation 0.2, while the remainder were drawn from a distribution with standard deviation 1.0.

The coefficients described above are sufficient to define each species' conditional occurrence probability (i.e. its probability of occurrence against any given backdrop of biotic and abiotic features).  I used these conditional probabilities to produce examples of communities that were consistent with the competition parameters and with the local environmental variables via Markov chain Monte Carlo (specifically, `r n_gibbs` rounds of Gibbs sampling; see code in the Appendix). I then used the methods from the next section to attempt to infer the underlying parameters from the simulated data.

## Comparison with directed models

[[In response to Chapter 2, reviewers suggested comparisons with two other methods based on directed acyclic graphs.  The first one has a latent multivariate Gaussian, and relies on the correlation structure of that Gaussian to help determine which species interact.  The second one is based on sparse directed graphs among the species in the network. Should I address one or both of these approaches in this chapter as well?]]

# Results

![Stochastic approximation decreases the model’s error over time. **A.** With small networks where the exact maximum likelihood estimates are known, stochastic approximation reaches the global optimum very quickly. **B.** With larger networks, where the “true” parameter values that generated the network are known but the maximum likelihood estimates for the observed landscape are not, stochastic approximation initially drives the error down very quickly, and then slowly approaches the apparent optimum.](convergence.pdf)

For the smaller communities, the squared deviations between the exact estimates produced by the `rosalia` package and the ones produced by stochastic approximation quickly decayed to negligible levels [[Figure 2A]], indicating that the stochastic approximation procedure was implemented correctly and worked as the mathematical theory predicts.  

![“True” network parameters for all 31,125 pairwise interactions versus the estimates from the three methods presented. Blue lines represent linear regressions through each cloud of points.](estimates.pdf)

For the larger landscape, I found that the stochastic approximation approach achieved reasonably good performance after less than a minute of optimization [Figure 2B]. With additional time, was able to recover most of the variance in species’ pairwise interactions from observational data ($R^2 = 0.66$; Figure 3A), and nearly all of the variance in their responses to environmental variables ($R^2 = 0.95$, not shown).

While the maximum likelihood estimates produced by the Markov network worked well, the sample correlation, explained a negligible fraction of the variance in species’ pairwise interactions ($R^2 = 0.03$, Figure 3B).  To the extent that ecologists’ other test statistics for co-occurrence are similar to the sample correlation [[*evidence to be added to chapter 2*]], they can be expected to perform equally poorly. As shown previously, the partial correlation was a much better indicator of species’ true interactions than the sample correlation ($R^2 = 0.44$ Figure 3C).

# Discussion

For decades, ecologists have relied on poor test statistics for inferring species interactions from observational data [@harris_estimating_2015]. As shown here and in @harris_estimating_2015, however, these inferences can only be made reliably by methods that control for other species in the network, such as partial correlations or Markov networks.  The biggest computational problem with large Markov networks is the impossibility of averaging over all their possible states, but these results demonstrate that this step can be avoided in ecological analyses.  Stochastic approximation is able to recover the same estimates as exact methods for smaller networks, while scaling gracefully to networks with hundreds of species.

The largest downside of using stochastic approximation instead of the exact methods introduced in @harris_estimating_2015 is the difficulty in generating confidence intervals.  The `rosalia` package can produce confidence intervals based on the Hessian matrix, but it is not feasible to calculate this matrix for large networks.  It may turn out that the best way to generate confidence intervals for large networks is by repeatedly fitting the model to bootstrapped samples of the data. Alternatively, ecologists may be able to take advantage of the advanced Monte Carlo techniques introduced in @murray_mcmc_2012 to sample from the posterior distribution over possible parameter values, which could be used to generate credible intervals for the parameter estimates. Other advanced Monte Carlo methods [e.g. @salakhutdinov_learning_2009] may also speed up convergence to the maximum likelihood estimate in cases where serial autocorrelation in the Gibbs sampler is too strong for effectively sampling the space of possible landscapes.

As the number of potentially-interacting species increases, the number of adjustable parameters increases even faster, so overfitting becomes a major concern. Fortunately, a number of good regularizers have been proposed.  Of these, some of the most interesting options include $L_1$ regularization, which ensures that many of the estimated coefficients are exactly zero [[refs]].  This sparsity matches ecologists’ intuition that many species from different guilds are unlikely to interact much at all [[refs]], and also produces computational benefits for model estimation. Of course, the best regularizers will take advantage of prior ecological knowledge (e.g. from field experiments, natural history, or trait data) to provide information about individual pairwise interactions, rather than about their overall distribution.

Richer forms of data, e.g. from observational time series or controlled experiments, could help ecologists recover more information about species interactions than is possible with the kinds of observational data analyzed here: in particular, these richer forms of data will be necessary to answer questions about which species in a positively associated pair is facilitating the other or which species in a negatively associated pair is excluding the other.

Ecologists could expand beyond simple Markov networks in a number of ways that would improve their ability to address a wider range of questions.  This paper demonstrated that it is possible to simultaneously estimate species’ responses to the abiotic and environment and to one another, but many other extensions are possible. For example, ecologists could condition the model on variables whose values have not been measured (e.g. partially-observed Markov networks, or the approximate networks in the `mistnet` package). This would allow ecologists to account for measurement error and for other ecologically-important factors that can be difficult to measure. Ecologists should also explore higher-order networks, where one species’ presence can affect the relationship between two other species.

# References
