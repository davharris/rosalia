*Running head:* Species interactions in Markov networks

**Title: Estimating species interactions from observational data with Markov
networks**

**Author:** David J. Harris: Population Biology; 1 Shields Avenue, Davis CA, 95616

***Abstract***

Estimating species interactions from observational data is one of the most
controversial tasks in community ecology. One difficulty is that a single
pairwise interaction can ripple through an ecological network and produce
surprising indirect consequences. For example, two competing species would
ordinarily correlate negatively in space, but this effect can be reversed in
the presence of a third species that is capable of outcompeting both of them
when it is present. Here, I apply models from statistical physics, called
Markov networks or Markov random fields, that can predict the direct and
indirect consequences of any possible species interaction matrix. Interactions
in these models can be estimated from observational data via maximum
likelihood. Using simulated landscapes with known pairwise interaction
strengths, I evaluated Markov networks and several existing approaches. The
Markov networks consistently outperformed other methods, correctly isolating
direct interactions between species pairs even when indirect interactions or
abiotic environmental effects largely overpowered them. A linear
approximation, based on partial covariances, also performed well as long as
the number of sampled locations exceeded the number of species in the data.
Indirect effects reliably caused a common null modeling approach to produce
incorrect inferences, however.

**Key words:** Ecological interactions; Occurrence data; Species associations;
Markov network; Markov random field; Ising model; Biogeography;
Presence–absence matrix; Null model

\setlength{\parindent}{1cm}

\noindent  
***Introduction***

If nontrophic species interactions, such as competition, are important drivers
of community assembly, then ecologists might expect to see their influence in
our data sets [@macarthur_population_1958; @diamond_island_1975]. Despite
decades of work and several major controversies, however [@lewin_santa_1983;
@strong_ecological_1984; @gotelli_swap_2003; @connor_checkered_2013], existing
methods for detecting competition's effects on community structure are
unreliable [@gotelli_empirical_2009]. In particular, species' effects on one
another can become lost in the complex web of direct and indirect interactions
in real assemblages. For example, the competitive interaction between the
two shrub species in Figure 1A can become obscured by their shared tendency
to occur in unshaded areas (Figure 1B). If this sort of effect is common, then
the vast majority of ecologists' methods, which rely on test statistics describing
the total number of co-occurrences or overall correlation between putatively
interacting species [@diamond_island_1975; @strong_ecological_1984;
@gotelli_empirical_2009; @veech_probabilistic_2013; @pollock_understanding_2014]
will not generally provide much evidence regarding species' direct effects on
one another.

While competition doesn't reliably leave the expected pattern in community
structure (a low co-occurrence rate at the landscape level), it nevertheless does
leave a signal in the data (Figure 1C). Specifically, *among shaded sites*,
there will be a deficit of co-occurrences between the competing shrub species,
and *among unshaded sites*, there will also be such a deficit. More generally,
we can obtain much better estimates of the association between two species from
their conditional relationships (i.e. by controlling for other species in the
network) than we could get from their overall co-occurrence rates.

In this paper, following recent work by @azaele_inferring_2010 and
@fort_statistical_2013, I show that Markov networks [undirected graphical models
also known as Markov random fields; @murphy_machine_2012] can provide a framework
for understanding the landscape-level consequences of pairwise species
interactions, and for detecting them from observational data. Markov networks
have been used in many scientific fields for decades to model associations
between various kinds of "particles". For example, a well-studied network named the Ising model has played an
important role in our understanding of physics [where nearby particles tend to
align magnetically with one another; @cipra_introduction_1987]. In spatial
contexts, these models have been used to describe interactions between
adjacent grid cells [@harris_contact_1974; @gelfand_modelling_2005]. In
neurobiology, they have helped researchers determine which neurons are
connected to one another by modeling the structure in their firing patterns
[@schneidman_weak_2006]. While ecologists explored some related approaches in the 1980's
[@whittam_species_1981], computational limitations had previously imposed
severe approximations that produced unintelligible results [e.g.
"probabilities" greater than one; @gilpin_factors_1982].  Now that it is
computationally feasible to fit these models exactly, this kind of approach has become
worth a second look.

The rest of the paper proceeds as follows. First, I discuss how Markov networks
operate and how they can be used to simulate landscape-level data or to predict
the direct and indirect consequences of possible interaction matrices. Then,
using simulated data sets where the "true" ecological structure is known, I
compare this approach with several existing methods for detecting species
interactions. Finally, I discuss opportunities for extending the approach
presented here to larger problems in community ecology.

\noindent  ***Methods***

\noindent  
***Conditional relationships and Markov networks.***
Ecologists are often interested in learning about direct interactions between
species, controlling for the indirect influence of other species. In
statistical terms, this implies that ecologists want to estimate *conditional*
("all-else-equal") relationships, rather than *marginal* ("overall") relationships.
The most familiar conditional relationship
is the partial correlation, which indicates the portion of the sample correlation
between two species that remains after controlling for other variables in the
data set [@albrecht_spatial_2001]. The example with the shrubs and trees in
Figure 1 shows how the two correlation measures can have opposite signs,
and suggests that the partial correlation is more relevant
for drawing inferences about species interactions (e.g. competition).
Markov networks extend this approach to non-Gaussian data, much as
generalized linear models do for linear regression [@lee_learning_2012].

Markov networks give a probability value for every possible combination of
presences and absences in communities. For example, given a network with
binary outcomes (i.e. 0 for absence and 1 for presence), the relative
probability of observing a given presence-absence vector, $\vec{y}$, is given
by

$$p(\vec{y}; \alpha, \beta) \propto exp(\sum_{i}\alpha_i y_i + \sum_{i\neq j}\beta_{ij}y_i y_j).$$

Here, $\alpha_{i}$ is an intercept term determining the amount that
the presence of species $i$ contributes
to the log-probability of $\vec{y}$; it directly controls the prevalence of
species $i$. Similarly, $\beta_{ij}$ is the amount that the co-occurrence of
species $i$ and species $j$ contributes to the log-probability; it controls
the probability that the two species will be found together (Figure 2A, Figure 2B).
$\beta$ thus acts as an analog of the partial covariance, but for non-Gaussian
networks. Because the relative probability of a presence-absence vector
increases when positively-associated species co-occur and decreases when
negatively-associated species co-occur, the model tends to produce assemblages
that have many pairs of positively-associated species and relatively few pairs
of negatively-associated species (exactly as an ecologist might expect).

A major benefit of Markov networks is the fact that the conditional
relationships between species can be read directly off the matrix of $\beta$
coefficients [@murphy_machine_2012]. For example, if the coefficient linking
two mutualist species is $+2$, then---all else equal---the odds of observing
either species increase by a factor of $e^2$ when its partner is present
[@murphy_machine_2012]. Of course, if all else is *not* equal (e.g. Figure 1,
where the presence of one competitor is associated with release from another
competitor), then species' marginal association rates can differ from this
expectation. For this reason, it is important to consider how coefficients'
effects propagate through the network, as discussed below.

Estimating the marginal relationships predicted by a Markov network is more
difficult than estimating conditional relationships, because doing so requires
absolute probability estimates. Turning the relative probability given by
Equation 1 into an absolute probability entails scaling by a normalizing constant, $Z(\alpha, \beta)$, which is defined so that that the probabilities of all
possible assemblages that could be produced by the model sum to one (bottom of
Figure 2B). Calculating $Z(\alpha, \beta)$ exactly, as is done in this paper,
quickly becomes infeasible as the number of species increases: with
$2^N$ possible assemblages of $N$ species, the number of bookkeeping operations
required spirals exponentially into the billions and beyond.
Numerous techniques are available for working with Markov networks that keep
the computations tractable, e.g. via analytic approximations
[@lee_learning_2012] or Monte Carlo sampling [@salakhutdinov_learning_2008],
but they are beyond the scope of this paper.

\noindent  
***Inferring $\alpha$ and $\beta$ coefficients from presence-absence data.***
In the previous two sections, the values of $\alpha$ and $\beta$ were known. In practice,
however, ecologists will often need to estimate these parameters from co-occurrence data.
When the number of species is reasonably small, one can compute exact maximum
likelihood estimates for all of the $\alpha$ and $\beta$ coefficients by optimizing
$p(\vec{y}; \alpha, \beta)$. Fully-observed Markov
networks like the ones considered here have unimodal likelihood surfaces
[@murphy_machine_2012], ensuring that this procedure will always converge on
the global maximum. This maximum is the unique combination of $\alpha$ and $\beta$
coefficients that would be expected to produce exactly the observed co-occurrence
frequencies. For the analyses in this paper, I used the *rosalia* package
[@harris_rosalia_2015] for the R programming language [@r_core_team_r_2015] to
define the objective function and gradient as R code.  The rosalia package then
uses the `BFGS` method in R's `optim` function to find the best values for $\alpha$
and $\beta$.

\noindent  
***Simulated landscapes.***
In order to compare different methods, I simulated two sets of landscapes using known
parameters.

The first set of simulated landscapes included the three competing species
shown in Figure 1. For each of 1000 replicates, I generated a landscape with
100 sites by sampling exactly from a probability distribution defined by the
interaction coefficients in that figure (Appendix A). Each of the methods
described below (a Markov network, two correlation-based methods and a null
model) was then evaluated on its ability to correctly infer that the two
shrub species competed with one another, despite their frequent co-occurrence.

I also simulated a second set of landscapes using a stochastic community
model based on generalized Lotka-Volterra dynamics, as described in the
Appendix. In these simulations, each species pair was randomly assigned to
either compete for a portion of the available carrying capacity (negative
interaction) or to act as mutualists (positive interaction).  In these
simulations, mutualism operated by mitigating the effects of intraspecific
competition on each partner's death rate.  For these analyses, I simulated
50 replicate landscapes, each with 25, 200, or 1600 sites and 20 species.

\noindent  
***Recovering species interactions from simulated data.***
I used Markov networks and  several other techniques for determining the sign and strength
of the associations between pairs of species (Appendix B).

For the Markov networks, I used the rosalia package [@harris_rosalia_2015], as described
above. Given the large number of parameters associated with some of the networks to
be estimated, I regularized the likelihood using a Cauchy prior distribution
[@gelman_weakly_2008] with a scale of 1 on the $\alpha$ and $\beta$ terms.

I also evaluated five alternative methods from the existing literature to calibrate the
performance of the Markov network as a method for estimating species interactions.
The first two alternative interaction measures were the sample correlations and the
partial correlations between each pair of species' data vectors on the landscape
[@albrecht_spatial_2001; @faisal_inferring_2010]. Because partial correlations are undefined
for landscapes with perfectly-correlated species pairs, I used a regularized
estimate based on James-Stein shrinkage, as implemented in the corpcor package’s
`pcor.shrink` function with the default settings [@REF]. In the context of non-Gaussian
data, the partial correlation can be thought of as an approximation to the Markov network,
and is much easier to compute.

The third alternative, generalized linear models, can also be thought of as a computationally
efficient approximation to the Markov network [@REF].  Following @faisal_inferring_2010,
I fit regularized logistic regression models for each species, using the other species on the
landscape as predictors. [[Observational presence-absence data does not have enough degrees
of freedom to estimate this many parameters, so I symmetrized the pairwise correlations by
averaging the coefficient for predicting species $i$’s status from species $j$ and vice versa.]]

The fourth alternative method, described in @gotelli_empirical_2009, involved simulating
possible landscapes from a null model that retains the row and column sums of
the original matrix [@strong_ecological_1984]. Using the default options in the
Pairs software described in @gotelli_empirical_2009, I simulated  the null
distribution of scaled C-scores (a test statistic describing the number of
*non*-co-occurrences between two species). The software then calculated a
$Z$ statistic for each species pair using this null distribution. After
multiplying this statistic by $-1$ so that positive values corresponded to
facilitation and negative values corresponded to competition, I used it as
another estimate of species interactions.

Finally, I used the latent correlation matrix estimated by the BayesComm package [@REF]
to evaluate the claim from recent papers that the correlation coefficients estimated by “joint
species distribution models” provide an accurate assessment of species’ pairwise interactions
[@pollock_understanding_2014; see also @harris_generating_2015].

\noindent  
***Evaluating model performance.***
For the simulated landscapes based on Figure 1, method evaluation was fairly
qualitative: any method whose test statistic for the two shrubs indicated a
negative relationship passed; other methods failed. For methods that provide
confidence intervals or other inferential statistics, I reported them below.

Because the different methods mostly describe species interactions on different
scales (e.g. correlations versus $Z$ scores versus regression coefficients), I used
linear regression through the origin to rescale the different estimates produced
by each method so that they had a consistent interpretation. After rescaling each
method’s estimates, I calculated squared errors for each of the [[N]] species pairs
across all the simulated data sets and used these values to calculate the proportion of variance
explained for landscapes with 25, 200, or 1600 sampled locations (compared with a baseline
model that assumed all interaction strengths to be zero).

\noindent  
***Results***

\noindent  
***Three species.***
As shown in Figure 1, the marginal relationship between the two shrub species
was positive---despite their competition for space at a mechanistic level---due
to indirect effects of the dominant tree species. As a result, the
covariance method falsely reported positive associations for 94% of the simulated
landscapes, and the randomization-based null model falsely reported such
associations 100% of the time. The two methods for evaluating conditional
relationships (Markov networks and partial covariances), however, successfully
controlled for the indirect pathway via the tree species and each correctly
identified the direct negative interaction between the shrubs 94% of the time.

\noindent  
***Larger landscapes.***
The accuracy of the four evaluated methods varied substantially, depending on
the parameters that produced the simulated communities (Figure 3). In general,
however, there was a consistent ordering: overall, the Markov network
explained 54% of the "true" parameters' squared deviations from zero, followed
by partial covariances (33%), and sample covariances (22%). The null model
scores initially explained only 12%. After manually reducing the value of one
especially strong outlier ($Z=1004$, implying $p<10^{-1000000}$), this
increased to 17% (Appendix B).  Figure 3 reflects the adjusted version of the
results.

\noindent  
***Discussion***

\noindent  
The results presented above show that Markov networks can reliably recover
species' pairwise interactions from observational data, even for cases where
a common null modeling technique reliably fails. Specifically, Markov networks
were successful even when direct interactions were largely overwhelmed by indirect
effects (Figure 1) or environmental effects (lower panels of Figure 3). For cases
where fitting a Markov network is computationally infeasible, these results also
indicate that partial covariances---which can be computed straightforwardly by linear
regression---can often provide a surprisingly useful approximation. The
partial correlations' success on simulated data may not
carry over to real data sets, however; @loh_structure_2013 show that the linear
approximations can be less reliable in cases where the true interaction matrix
contains more structure (e.g. guilds or trophic levels). On the other hand,
if ecologists are familiar enough with the natural history of their study
systems to describe this kind of structure as a prior distribution on the
parameters or as a penalty on the likelihood, then this information could
reduce the effective degres of freedom to estimate and real-world results might
be even better than those shown in Figure 3.

Ecologists will also need natural history to pin down the exact nature of the
interactions identified by a network model (e.g. which species in a
positively-associated pair is facilitating the other),  particularly when real
pairs of species can reciprocally influence one another in multiple ways
simultaneously [@bruno_inclusion_2003]; the $\beta$ coefficients in Markov
networks have to reduce this complexity  to a single number. In short, partial
correlations and Markov  networks both help prevent us from mistaking marginal
associations for conditional ones, but they can't tell us the underlying
biological mechanisms at work.

Despite these limitations, Markov networks have enormous potential to improve
ecological inferences. For example, Markov networks provide a simple answer
to the question of how competition should affect a species' overall
prevalence, which was a major flash point for the null model debates in the
1980’s [@roughgarden_competition_1983; @strong_ecological_1984]. Equation
1 can be used to calculate the expected prevalence of a species in the
absence of biotic influences [$\frac{1}{1 + e^{-\alpha}}$; @lee_learning_2012].
Competition's effect on prevalence in a Markov network can then be calculated
by subtracting this value and the observed prevalence (cf Figure 2D).

Markov networks---particularly the Ising model for binary networks---have been studied
in statistical physics for nearly a century [@cipra_introduction_1987],
and the models' properties,
capabilities, and limits are well-understood in a huge range of applications,
from spatial statistics [@gelfand_modelling_2005] to neuroscience
[@schneidman_weak_2006] to models of human behavior [@lee_statistical_2013].
Modeling species interactions using the same framework would thus allow
ecologists to tap into an enormous set of existing discoveries and techniques
for dealing with indirect effects, stability, and alternative stable states
(i.e. phase transitions; @cipra_introduction_1987).

This modeling approach is also highly
extensible, even when it is inconvenient to compute the likelihood exactly.
For example, the mistnet software package for joint species distribution modeling
[@harris_generating_2015] can fit *approximate* Markov networks to large
species assemblages (>300 species) while simultaneously modeling each species'
nonlinear response to the abiotic environment. Combining multiple ecological
processes into a common model could help ecologists to disentangle different
factors that can confound simpler co-occurrence analyses [cf @connor_checkered_2013].
Numerous other extensions are possible: Markov networks
can be fit with a mix of discrete and continuous variables, for example
[@lee_learning_2012]. There are even methods [@whittam_species_1981;
@tjelmeland_markov_1998] that would allow the coefficient linking two species
in an interaction matrix to vary as a function of the abiotic environment or
of third-party species that tip the balance between facilitation and
exploitation [@bruno_inclusion_2003].

Finally, the results presented here have important implications for
ecologists' continued use of null models to draw inferences about species
interactions. Null and neutral models can be very useful for clarifying our
thinking about the numerical consequences of species' richness and abundance
patterns [@harris_occupancy_2011; @xiao_strong_2015], but deviations from a
null model must be interpreted with care [@roughgarden_competition_1983]. In
complex networks of ecological interactions (and even in small networks with
three species), it may simply not be possible to implicate individual species
pairs or specific ecological processes like competition by rejecting a
general-purpose null [@gotelli_empirical_2009]. Estimating pairwise
coefficients directly seems like a much more promising approach: to the extent
that the models' relative performance on real data sets is similar to the
range of results shown in Figure 3, scientists in this field could easily
double their explanatory power by switching from null models to linear
regression and partial covariances, or triple it by switching to a Markov
network.

\noindent  
***Acknowledgements:***
This research was funded by a Graduate Research Fellowship from the US
National Science Foundation and benefited greatly from discussions with A.
Sih, M. L. Baskett, R. McElreath, R. J. Hijmans, A. C. Perry, and C. S. Tysor.
Additionally, A. K. Barner, E. Baldridge, E. P. White, D. Li, D. L. Miller, N.
Golding, and N. J. Gotelli provided useful feedback on an earlier draft of
this work.

\setlength{\parindent}{0cm}

***References:***


***Figure captions***

***Figure 1.***
**A.** A small network of three competing species. The tree (top) tends not to
co-occur with either of the two shrub species, as indicated by the strongly
negative coefficient linking them. The two shrub species also compete with one
another, as indicated by their negative coefficient (circled), but this effect
is substantially weaker. **B.** In spite of the competitive interactions
between the two shrub species, their shared tendency to occur in locations
without trees makes their occurrence vectors positively correlated (circled).
**C.** Controlling for the tree species' presence with a conditional method
such as a partial covariance or a Markov network allows us to correctly
identify the negative interaction between these two species (circled).

***Figure 2.***
**A.** A small Markov network with two species.  The depicted abiotic
environment favors the occurrence of both species ($\alpha >0$), particularly
species 2 ($\alpha_2 > \alpha_1$). The  negative $\beta$ coefficient linking
these two species implies that they co-occur less than expected under
independence.  **B.** Relative probabilities of all four possible presence-absence
combinations for Species 1 and Species 2. The exponent includes
$\alpha_1$ whenever Species 1 is present ($y_1 = 1$), but not when it is
absent ($y_1 = 0$).  Similarly, the exponent includes $\alpha_2$ only when
species $2$ is present ($y_2 = 1$), and $\beta$ only when both are present
($y_1y_2 = 1$). The normalizing constant $Z$, ensures that the four relative
probabilities sum to 1.  In this case, $Z$ is about 18.5.  **C.** Using the
probabilities, we can find the expected frequencies of all possible co-occurrence
 patterns between the two species of interest. **D.** If $\beta$
equaled zero (e.g. if the species no longer competed for the same resources),
then the reduction in competition would allow each species to increase its
occurrence rate and the deficit of co-occurrences would be eliminated.



***Figure 3.***
Proportion of variance in interaction coefficients explained by each method
with 5, 10, or 20 species arrayed across varying numbers of sampled locations
when environmental filtering was absent (top row) or present (bottom row). A
negative $R^2$ values implies that the squared error associated with
the corresponding subset of the predictions was larger than the error one would
get from assuming that all coefficients equalled zero.
